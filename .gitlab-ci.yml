image: parity/kubetools:latest
variables:
  PROJECT:                         $CI_PROJECT_PATH_SLUG
  CI_REGISTRY:                     "gcr.io/test-installations-222013"
  KUBE_NAMESPACE:                  $PROJECT
  GIT_STRATEGY:                    fetch
  GIT_DEPTH:                       3

stages:
  - dockerize
  - deploy

cache:
  key:                             '${CI_JOB_NAME}'
  paths:
    - node_modules/
    - packages/*/node_modules/

#### stage:                        dockerize
.build_and_push:                   &build_and_push
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://localhost:2375
  tags:
    - kubernetes-parity-build
  image: docker:git
  services:
    - docker:dind
  script:
    - export DOCKER_IMAGE="${CI_REGISTRY}/${PROJECT}-${CI_JOB_NAME}"
    #- export DOCKER_TAG=""
    - export DOCKER_TAG="citest"
    - export DOCKER_IMAGE_FULL_NAME=$DOCKER_IMAGE:$DOCKER_TAG
    - echo "$DOCKER_REGISTRY_JSON" | docker login -u _json_key --password-stdin https://gcr.io
    - docker build -t "$DOCKER_IMAGE_FULL_NAME" $CI_JOB_NAME
    - docker push "$DOCKER_IMAGE_FULL_NAME"

front-end:
  stage: dockerize
  environment:
    name: parity-build
  only:
      - /^k8s/
#  rules:
#    - changes:
#      - "front-end/**/*"
  <<: *build_and_push

deploy:
  stage: deploy
  environment:
    name: dashboards-cluster-1
  tags:
    - kubernetes-parity-build
  only:
      - /^k8s/
  script:
    - cat kubernetes/deploy.yaml.template | envsubst | kubectl --dry-run --validate -n polkassembly apply -f -
    - cat kubernetes/deploy.yaml.template | envsubst | kubectl -n polkassembly apply -f -
